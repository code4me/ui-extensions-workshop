## Answer Exercise 5

### HTML

``` html
<div class="row vertical">
  <label for="type_of_bicycle" title="Type of bicycle">Type of bicycle</label>
  <select id="type_of_bicycle">
    <option value=""></option>
    <option value="road">Road</option>
    <option value="mountain">Mountain</option>
    <option value="recumbent">Recumbent</option>
  </select>
</div>

<div id="bicycle-fields">
  <div id="size-row" class="row vertical">
    <label for="size" title="Size">Size</label>
    <select id="size"></select>
  </div>

  <div id="chain-size-row" class="row vertical">
    <label for="chain_size" title="Chain size">Chain size</label>
    <input id="chain_size" type="text" autocomplete="off">
  </div>

  <div id="tire-size-row" class="row vertical">
    <label for="tire_size" title="Tire size">Tire size</label>
    <input id="tire_size" type="text" autocomplete="off">
  </div>

  <div id="front-shocks-row" class="row vertical">
    <label for="front_shocks" title="Front shocks">Front shocks</label>
    <input id="front_shocks" type="text" autocomplete="off">
  </div>

  <div id="rear-shocks-row" class="row vertical">
    <label for="rear_shocks" title="Rear shocks">Rear shocks</label>
    <input id="rear_shocks" type="text" autocomplete="off">
  </div>

  <div id="tape-color-row" class="row vertical">
    <label for="tape_color" title="Tape color">Tape color</label>
    <input id="tape_color" type="text" autocomplete="off">
  </div>

  <div id="flag-row" class="row vertical">
    <label for="flag" title="Flag">Flag</label>
    <input id="flag" type="text" autocomplete="off">
  </div>
</div>
```

### CSS

``` scss
#bicycle-fields {
  .row { display: none; }
}
```

### JavaScript

``` js
var $ = ITRP.$;            // jQuery
var $extension = $(this);  // The UI extension container with custom HTML

var $bicycleType   = $("#type_of_bicycle", $extension);
var $bicycleFields = $("#bicycle-fields", $extension);
var $sizeField     = $("#size", $extension);

var configurationByType = {
  "road": {
    "required": ["#tire_size", "#tape_color"],
    "sizes": [
      "",
      44, 45, 46, 47, 48, 49,
      50, 51, 52, 53, 54, 55, 56, 57, 58, 59,
      60, 61, 62, 63, 64, 65, 66
    ],
    "visible": ["#size", "#chain_size", "#tire_size", "#tape_color"]
  },
  "mountain": {
    "required": ["#chain_size", "#front_shocks"],
    "sizes": ["", 13, 14, 15, 16, 17, 18, 19, 20, 21, 22],
    "visible": ["#size", "#chain_size", "#tire_size", "#front_shocks", "#rear_shocks"]
  },
  "recumbent": {
    "required": ["#flag"],
    "sizes": ["", 42],
    "visible": ["#size", "#chain_size", "#tire_size", "#flag"]
  },
};

// Generates a String contain an <option> element for each value in the
// `options` Array.
function generateOptions(options) {
  return options.map(function(option) {
    return "<option value='" + option + "'>" + option + "</option>";
  }).join();
}

$bicycleType.change(function() {
  // Hide and remove requiredness from all fields.
  $('.row', $bicycleFields).hide();
  $('input', $bicycleFields).required(false);

  if (this.value !== "") {
    // Show fields.
    var visible = configurationByType[this.value].visible.join(",");
    $(visible, $bicycleFields).closest(".row").show();

    // Mark fields required.
    var required = configurationByType[this.value].required.join(",");
    $(required, $bicycleFields).required();

    // Load the frame sizes and reset the selected value.
    var sizes = configurationByType[this.value].sizes;
    var optionsHtml = generateOptions(sizes);
    $sizeField.html(optionsHtml).val("");
  }
}).change();
```

If we had specified all options in HTML, we would've needed 3 select list as
well and more CSS to hide/show the correct one. That solution would've been

* more work,
* more complex, and
* more difficult to maintain (think: adding another type of bike).

Instead, the options will be dynamically generated by the JavaScript code.

---

Similar to the previous example, we store the different sizes that are available
per type in the configuration object:

``` js
var configurationByType = {
  ...
  "mountain": {
    "required": ["#chain_size", "#front_shocks"],
    "sizes": ["", 13, 14, 15, 16, 17, 18, 19, 20, 21, 22],
    "visible": ["#size", "#chain_size", "#tire_size", "#front_shocks", "#rear_shocks"]
  },
  ...
}
```

This object is used in the onChange-event handler to generate the different
option-elements.

When the option labels and values are different you need to store an Array of
objects or Arrays instead of only values. I prefer an Array of Arrays as it is
less typing, but an Array of Objects is more readable.

``` js
// Array of Arrays
"sizes": [
  ["", ""],
  ["Size 44", 44]
  ["Size 45", 45],
  ...
],

// Array of Objects
"sizes": [
  { label: "", value: "" },
  { label: "Size 44", value: 44 }
  { label: "Size 45", value: 45 },
  ...
],
```

---

Next is a helper function that generates the options of the select element:

``` js
// Generates a String contain an <option> element for each value in the
// `options` Array.
function generateOptions(options) {
  return options.map(function(option) {
    return "<option value='" + option + "'>" + option + "</option>";
  }).join();
}
```

Adding a comment explaining what the function does helps other people and also
helps your future self.

The `.map()` function might be new. It is available on Arrays and passes each
element in the Array through a function, producing a new Array containing the
return values. For example:

``` js
[1, 2, 3].map(function(i) {
  return (2 * i);
})
// => [2, 4, 6]

[44, 45, 46].map(function(size) {
  return "Size " + size;
})
// => ["Size 44", "Size 45", Size 46"]
```

The result of `.map()` call is an array of Strings like `<option
value='44'>44</option>`. These are joined together with the `join()` function
that was discussed earlier.

---

The only thing that is left is generating the correct options and loading them
into the HTML:

``` js
// Load the frame sizes and reset the selected value.
var sizes = configurationByType[this.value].sizes;
var optionsHtml = generateOptions(sizes);
$sizeField.html(optionsHtml).val("");
```

The `configurationByType[this.value].sizes` call will return the sizes for the
selected type of bicycle. This is similar to how the required fields are
selected.

The sizes are given to the `generateOptions` function that in turn returns a
String containing all options in HTML.

jQuery has a `.html(htmlString)` function that is documented
[here](https://api.jquery.com/html/#html2). It has the following description:

```
Set the HTML contents of each element in the set of matched elements.

.html( htmlString )

  htmlString
  Type: htmlString
  A string of HTML to set as the content of each matched element.
```

Using `$sizeField.html(optionsHtml)` it is simple to load the options for the
selected type of bicycle into the "Size" select element.

The extra `.val("")` call is needed to reset the selected option back to empty
option. Otherwise, the previous selected option will still be shown.

[Continue to the next exercise.](06-detecting-self-service.md)
